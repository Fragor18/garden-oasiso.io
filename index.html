<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OASIS ‚Äî Atmosphere & Pests</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #2e7d32; --accent: #4caf50; 
            --gold: #ffcc00; --sky-day: #4facfe; --sky-night: #1e3a8a;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Ubuntu', sans-serif; background-color: #000; overflow: hidden; }

        /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω –Ω–µ–±–∞ */
        #sky { 
            position: fixed; inset: 0; z-index: -2; 
            transition: background 5s ease;
            background: var(--sky-day);
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –¥–æ–∂–¥—è */
        #rainCanvas { 
            position: fixed; inset: 0; z-index: -1; 
            pointer-events: none; display: none;
        }

        .cheat-btn { position: fixed; bottom: 15px; right: 15px; background: #ff0000; color: white; border: 3px solid white; width: 45px; height: 45px; border-radius: 12px; z-index: 1000000; cursor: pointer; font-weight: bold; }

        #authLayer { position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; }
        .card { background: white; padding: 30px; border-radius: 30px; width: 90%; max-width: 350px; text-align: center; border: 4px solid var(--primary); }
        .auth-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 15px; border: 2px solid #ddd; }

        .layer { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; z-index: 10; padding-top: 100px; }
        .hidden { display: none !important; }

        .btn { padding: 12px 20px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-green { background: var(--primary); color: white; }

        .site-header { position: absolute; top: 0; width: 100%; padding: 10px; display: flex; justify-content: space-between; align-items: center; z-index: 100; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); color: white; }

        .weather-icon { font-size: 1.5rem; margin: 0 5px; }

        .garden-grid { display: grid; gap: 10px; padding: 10px; padding-bottom: 120px; }
        .is-pc .garden-grid { grid-template-columns: repeat(4, 160px); }
        .is-mobile .garden-grid { grid-template-columns: repeat(2, 1fr); width: 100%; }

        .garden-slot { aspect-ratio: 4/5; background: rgba(255,255,255,0.1); border: 2px dashed rgba(255,255,255,0.3); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; }
        
        .plant-card { width: 100%; height: 100%; background: rgba(255,255,255,0.9); color: #333; border-radius: 18px; padding: 8px; display: flex; flex-direction: column; align-items: center; position: relative; }
        .age-badge { position: absolute; top: 5px; right: 5px; background: #333; color: white; font-size: 8px; padding: 2px 4px; border-radius: 5px; }
        
        /* –í—Ä–µ–¥–∏—Ç–µ–ª—å */
        .pest { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); font-size: 1.5rem; animation: wobble 0.5s infinite; z-index: 5; }
        @keyframes wobble { 0%, 100% { transform: translateX(-50%) rotate(0); } 50% { transform: translateX(-50%) rotate(10deg); } }

        .bars { width: 100%; margin-top: auto; }
        .bar { width: 100%; height: 5px; background: #ddd; margin: 1px 0; border-radius: 3px; }
        .fill { height: 100%; transition: 0.5s; }

        .hotbar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px; z-index: 500; border: 1px solid var(--primary); }
        .tool { width: 45px; height: 45px; background: #222; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; color: white; }
        .tool.active { border: 2px solid var(--accent); background: #333; }

        #eventMsg { position: fixed; top: 120px; background: var(--gold); padding: 5px 15px; border-radius: 15px; font-weight: bold; display: none; z-index: 1000; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div id="sky"></div>
    <canvas id="rainCanvas"></canvas>
    <div id="eventMsg">–ó–û–õ–û–¢–ê–Ø –õ–ò–•–û–†–ê–î–ö–ê x2</div>
    <button class="cheat-btn" onclick="openConsole()">\</button>

    <div id="authLayer">
        <div class="card">
            <h1 style="color:var(--primary); margin:0">OASIS ATMOSPHERE</h1>
            <p>–°–∏–º—É–ª—è—Ç–æ—Ä —Å–∞–¥–∞ 2026</p>
            <input type="text" id="nameInput" class="auth-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫">
            <button class="btn btn-green" style="width:100%" onclick="handleAuth()">–ò–≥—Ä–∞—Ç—å</button>
        </div>
    </div>

    <div id="gameUI" class="hidden">
        <header class="site-header">
            <div id="scoreDisplay">üí∞ 0</div>
            <div style="display:flex; align-items:center;">
                <span id="timeIcon" class="weather-icon">‚òÄÔ∏è</span>
                <span id="weatherIcon" class="weather-icon">‚òÅÔ∏è</span>
            </div>
            <div id="marketTimer">üõí 05:00</div>
        </header>

        <nav style="position: absolute; top: 60px; display: flex; gap: 5px; z-index: 100; width: 100%; justify-content: center;">
            <button class="btn btn-green" onclick="showPage('marketPage')">–†—ã–Ω–æ–∫</button>
            <button class="btn btn-green" onclick="showPage('gardenPage')">–°–∞–¥</button>
        </nav>

        <div id="marketPage" class="layer">
            <div id="marketList" style="width: 90%; max-width: 400px;"></div>
        </div>

        <div id="gardenPage" class="layer hidden">
            <div id="gardenGrid" class="garden-grid"></div>
            <div class="hotbar">
                <div class="tool active" id="t-water" onclick="setTool('water')">üíß</div>
                <div class="tool" id="t-food" onclick="setTool('food')">üß™</div>
                <div class="tool" id="t-trash" onclick="setTool('trash')">üóëÔ∏è</div>
            </div>
        </div>
    </div>

    <div class="overlay" id="modalOverlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10000; display:none; justify-content:center; align-items:center;">
        <div class="modal" id="modalContent" style="background:white; padding:20px; border-radius:20px; width:80%; max-width:300px; text-align:center;"></div>
    </div>

    <script>
        const PLANTS = [
            { id: 0, name: '–ú–æ–Ω—Å—Ç–µ—Ä–∞', icon: 'üåø', income: 5, cost: 50, rarity: 1 },
            { id: 1, name: '–ö–∞–∫—Ç—É—Å', icon: 'üåµ', income: 15, cost: 200, rarity: 0.7 },
            { id: 2, name: '–†–æ–∑–∞', icon: 'üåπ', income: 45, cost: 900, rarity: 0.4 },
            { id: 3, name: '–ú—É—Ö–æ–ª–æ–≤–∫–∞', icon: 'ü™¥', income: 140, cost: 3500, rarity: 0.2 },
            { id: 4, name: '–ü–∞–ª—å–º–∞', icon: 'üå¥', income: 450, cost: 12000, rarity: 0.1 },
            { id: 5, name: '–ë–∞–º–±—É–∫', icon: 'üéã', income: 1100, cost: 45000, rarity: 0.05 }
        ];

        let currentUser = null;
        let gameData = { score: 150, slots: 3, garden: new Array(16).fill(null), inventory: [0, 0] };
        let marketSeeds = [];
        let marketTimer = 300;
        let currentTool = 'water';
        
        let weather = 'clear'; // clear, rain, heat
        let dayTime = 'day'; // day, evening, night
        let goldRush = false;

        function openConsole() {
            let c = prompt("–ö–æ–¥:");
            if(c === 'money') gameData.score += 1000000;
            if(c === 'rush') triggerGoldRush();
            save();
        }

        function handleAuth() {
            const name = document.getElementById('nameInput').value.trim();
            if(!name) return;
            let users = JSON.parse(localStorage.getItem('oasis_v3_save') || '{}');
            if(users[name]) gameData = users[name];
            currentUser = name;
            document.getElementById('authLayer').classList.add('hidden');
            document.getElementById('gameUI').classList.remove('hidden');
            document.body.className = 'is-mobile'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–æ–±–∏–ª—å–Ω—ã–π –≤–∏–¥
            updateMarket();
            renderGarden();
        }

        // –õ–æ–≥–∏–∫–∞ –Ω–µ–±–∞ –∏ –ø–æ–≥–æ–¥—ã
        function updateAtmosphere() {
            const sky = document.getElementById('sky');
            const rain = document.getElementById('rainCanvas');
            const tIcon = document.getElementById('timeIcon');
            const wIcon = document.getElementById('weatherIcon');

            // –í—Ä–µ–º—è —Å—É—Ç–æ–∫ (—Ü–∏–∫–ª 60 —Å–µ–∫ –¥–ª—è —Ç–µ—Å—Ç–∞)
            let sec = new Date().getSeconds();
            if(sec < 20) { dayTime = 'day'; sky.style.background = '#4facfe'; tIcon.innerText = '‚òÄÔ∏è'; }
            else if(sec < 40) { dayTime = 'evening'; sky.style.background = '#fb923c'; tIcon.innerText = 'üåÖ'; }
            else { dayTime = 'night'; sky.style.background = '#0f172a'; tIcon.innerText = 'üåô'; }

            // –ü–æ–≥–æ–¥–∞
            if(weather === 'rain') { 
                rain.style.display = 'block'; 
                wIcon.innerText = 'üåßÔ∏è'; 
                drawRain();
            } else if(weather === 'heat') {
                rain.style.display = 'none';
                wIcon.innerText = 'üî•';
                sky.style.filter = 'saturate(2) brightness(0.8)';
            } else {
                rain.style.display = 'none';
                wIcon.innerText = '‚òÅÔ∏è';
                sky.style.filter = 'none';
            }
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –¥–æ–∂–¥—è –Ω–∞ Canvas
        const ctx = document.getElementById('rainCanvas').getContext('2d');
        function drawRain() {
            ctx.canvas.width = window.innerWidth; ctx.canvas.height = window.innerHeight;
            ctx.clearRect(0,0, ctx.canvas.width, ctx.canvas.height);
            ctx.strokeStyle = 'rgba(174,194,224,0.5)'; ctx.lineWidth = 1;
            for(let i=0; i<30; i++) {
                let x = Math.random() * ctx.canvas.width;
                let y = Math.random() * ctx.canvas.height;
                ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x-5, y+15); ctx.stroke();
            }
        }

        function triggerGoldRush() {
            goldRush = true;
            document.getElementById('eventMsg').style.display = 'block';
            setTimeout(() => {
                goldRush = false;
                document.getElementById('eventMsg').style.display = 'none';
            }, 30000);
        }

        function updateMarket() {
            marketSeeds = [{ id: 0, count: 99 }];
            PLANTS.slice(1).forEach(p => {
                if(Math.random() < p.rarity + 0.1) marketSeeds.push({ id: p.id, count: Math.floor(Math.random()*3)+1 });
            });
            renderMarket();
        }

        function renderMarket() {
            let h = '<h2 style="color:white">–†—ã–Ω–æ–∫</h2>';
            marketSeeds.forEach((m, idx) => {
                let p = PLANTS[m.id];
                h += `<div class="item-row" style="background:white; padding:10px; margin:5px; border-radius:10px; display:flex; justify-content:space-between" onclick="buySeed(${idx})">
                    <span>${p.icon} ${p.name} (${m.count})</span>
                    <b>üí∞ ${p.cost}</b>
                </div>`;
            });
            document.getElementById('marketList').innerHTML = h;
        }

        function buySeed(idx) {
            let m = marketSeeds[idx];
            let p = PLANTS[m.id];
            if(gameData.score >= p.cost && m.count > 0) {
                gameData.score -= p.cost;
                gameData.inventory.push(p.id);
                m.count--;
                save(); renderMarket();
            }
        }

        function renderGarden() {
            const g = document.getElementById('gardenGrid'); if(!g) return;
            g.innerHTML = '';
            for(let i=0; i<16; i++) {
                let p = gameData.garden[i];
                let locked = i >= gameData.slots;
                let slot = document.createElement('div');
                slot.className = `garden-slot ${locked ? 'slot-locked' : ''}`;
                
                if(locked) {
                    let cost = gameData.slots * 1200;
                    slot.innerHTML = `üîí<br><small>üí∞${cost}</small>`;
                    slot.onclick = () => { if(gameData.score >= cost) { gameData.score -= cost; gameData.slots++; save(); renderGarden(); } };
                } else if(!p) {
                    slot.innerHTML = '‚ûï';
                    slot.onclick = () => openPlantMenu(i);
                } else {
                    let info = PLANTS[p.id];
                    slot.innerHTML = `
                        <div class="plant-card">
                            ${p.pest ? '<div class="pest">üêõ</div>' : ''}
                            <div class="age-badge">${Math.floor(p.age)}/50 –ª.</div>
                            <div style="font-size:2.5rem; margin-top:10px">${info.icon}</div>
                            <div class="bars">
                                <div class="bar"><div class="fill" style="width:${p.w}%; background:#3b82f6"></div></div>
                                <div class="bar"><div class="fill" style="width:${p.h}%; background:#22c55e"></div></div>
                            </div>
                        </div>`;
                    slot.onclick = () => {
                        if(p.pest) { p.pest = false; return renderGarden(); } // –ü—Ä–æ–≥–Ω–∞—Ç—å –≥—É—Å–µ–Ω–∏—Ü—É
                        if(currentTool === 'water') p.w = Math.min(p.w + 40, 100);
                        if(currentTool === 'food') p.h = Math.min(p.h + 30, 100);
                        if(currentTool === 'trash') gameData.garden[i] = null;
                        save(); renderGarden();
                    };
                }
                g.appendChild(slot);
            }
        }

        function openPlantMenu(sIdx) {
            if(gameData.inventory.length === 0) return alert("–ù–µ—Ç —Å–µ–º—è–Ω!");
            let h = '<h3>–ü–æ—Å–∞–¥–∏—Ç—å</h3>';
            gameData.inventory.forEach((id, invIdx) => {
                h += `<div class="item-row" style="padding:10px; border:1px solid #ddd; margin:5px; border-radius:10px" onclick="plantSeed(${sIdx}, ${invIdx})">${PLANTS[id].icon} ${PLANTS[id].name}</div>`;
            });
            document.getElementById('modalContent').innerHTML = h + `<button class="btn" onclick="closeM()">–û—Ç–º–µ–Ω–∞</button>`;
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        function plantSeed(sIdx, iIdx) {
            let id = gameData.inventory.splice(iIdx, 1)[0];
            gameData.garden[sIdx] = { id, w: 100, h: 100, age: 0, pest: false };
            closeM(); save(); renderGarden();
        }

        function save() {
            let users = JSON.parse(localStorage.getItem('oasis_v3_save') || '{}');
            users[currentUser] = gameData;
            localStorage.setItem('oasis_v3_save', JSON.stringify(users));
        }

        function closeM() { document.getElementById('modalOverlay').style.display = 'none'; }
        function showPage(p) {
            document.getElementById('marketPage').classList.add('hidden');
            document.getElementById('gardenPage').classList.add('hidden');
            document.getElementById(p).classList.remove('hidden');
        }

        function setTool(t) {
            currentTool = t;
            document.querySelectorAll('.tool').forEach(el => el.classList.remove('active'));
            document.getElementById('t-'+t).classList.add('active');
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
        setInterval(() => {
            if(!currentUser) return;
            
            marketTimer--;
            if(marketTimer <= 0) { marketTimer = 300; updateMarket(); }

            // –ü–æ–≥–æ–¥–∞ (—à–∞–Ω—Å 2% –∫–∞–∂–¥—É—é —Å–µ–∫)
            if(Math.random() < 0.02) {
                let r = Math.random();
                if(r < 0.7) weather = 'clear';
                else if(r < 0.9) weather = 'rain';
                else weather = 'heat';
            }
            updateAtmosphere();

            gameData.garden.forEach((p, i) => {
                if(p) {
                    let wLoss = 0.6;
                    if(weather === 'rain') wLoss = -2; // –ü–æ–ª–∏–≤ –¥–æ–∂–¥–µ–º
                    if(weather === 'heat') wLoss = 2.5; // –ò—Å–ø–∞—Ä–µ–Ω–∏–µ
                    p.w = Math.max(0, Math.min(100, p.w - wLoss));
                    
                    p.age += 0.05;
                    if(p.w < 20) p.h -= 0.8;

                    // –®–∞–Ω—Å –ø–æ—è–≤–ª–µ–Ω–∏—è –≤—Ä–µ–¥–∏—Ç–µ–ª—è (1% –µ—Å–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤–æ)
                    if(!p.pest && p.h > 50 && Math.random() < 0.005) p.pest = true;
                    
                    if(p.age >= 50 || p.h <= 0) {
                        gameData.garden[i] = null;
                    } else if(p.h > 40) {
                        let gain = PLANTS[p.id].income;
                        if(goldRush) gain *= 2;
                        if(p.pest) gain *= 0.5; // –í—Ä–µ–¥–∏—Ç–µ–ª—å —Å–Ω–∏–∂–∞–µ—Ç –¥–æ—Ö–æ–¥
                        gameData.score += gain;
                    }
                }
            });

            document.getElementById('scoreDisplay').innerText = `üí∞ ${Math.floor(gameData.score)}`;
            let m = Math.floor(marketTimer / 60), s = marketTimer % 60;
            document.getElementById('marketTimer').innerText = `üõí ${m}:${s<10?'0'+s:s}`;
            if(!document.getElementById('gardenPage').classList.contains('hidden')) renderGarden();
            save();
        }, 1000);
    </script>
</body>
</html>
